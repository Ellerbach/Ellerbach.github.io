# 2006-08-06 J'ai hack√© mon onduleur ou le reverse engineering de protocoles de communication (part 1)

C'est un titre un peu long mais bon, il exprime le fond de mon probl√®me : j'ai achet√© un onduleur (un [Belkin](https://www.belkin.com/)) pour mettre sur mon serveur et un de mes PC √† la maison. Par contre, faudra √™tre un peu patient car il va y avoir plusieurs post sur le sujet.

Le truc, c'est que l'application de gestion livr√©e avec est‚Ä¶ comment dire‚Ä¶ sans dire de gros mots‚Ä¶ un peu vieillissante et inutilisable pour faire de l'administration. Une vieille appli au look de la fin des ann√©es 90, pas d'acc√®s √† distance, pas de SNMP, pas de page Web, bref rien :-(. Pour ne pas pol√©miquer, je pr√©f√®re ne pas mettre de capture d'√©cran. Mais bon, pour les curieux, je vous les tiens √† disposition‚Ä¶

Du coup, je me suis lanc√© dans la recherche d'application un peu mieux. Au bout de quelques heures de recherche, quelques applications t√©l√©charg√©es et install√©es, je m'aper√ßois que tous les onduleurs ont un protocole de communication totalement diff√©rent. Les logiciels d'un constructeur ne fonctionnent qu'avec leur propre onduleur. Les applications sont d'ailleurs toutes tr√®s vari√©es, seules les versions pro proposent du SNMP et quasi pas de soft qui permette d'avoir un √©tat dans une page Web.

Je me suis donc rabattu sur le service ¬´ Onduleur ¬ª de Windows (on le trouve dans ¬´ Gestion d'√©nergie ¬ª sauf sur les portables). Et l√†, pas mieux. Un service de base o√π mis √† part si l'on poss√®de un [APC](https://www.apc.com/index.cfm?ISOCountryCode=fr), il n'y a pas grand-chose. Visiblement n'importe quel onduleur poss√®de des instructions minimums qui permettent de v√©rifier son √©tat : sur secteur, sur batterie, batterie faible. Les possibilit√©s sont tr√®s limit√©es : arr√™ter la machine et ex√©cuter un programme. Point barre.

Je suis donc parti sur l'√©criture d'un programme en ligne de commande qui permette d'envoyer un mail en SMTP. Cela me permettra en cas de panne √©lectrique d'√™tre alert√© par mail de la coupure de courant. Mieux que rien. Je me suis dit que √ßa allait me faire du bien, presque 2 ans et demi sans √©crire une ligne de code. Ca va me d√©rouiller un peu.

C√¥t√© outil, je pars donc sur [Visual Basic Express 2005](https://www.microsoft.com/france/msdn/vstudio/express/vbasicexpress.mspx). Une solution parfaite pour m'y remettre. Parfaite car j'adore Visual Basic (je ¬´ parle ¬ª aussi C/C++,Java, Pascal, Fortran, C#, ADA et ¬´ baragouine un peu ¬ª en Eiffel, Python, PhP). Parfaite aussi pour les √©tudiants, les d√©butants et les passionn√©s : le produit est gratuit, permet de d√©velopper en .NET 2.0 et offre des possibilit√©s de recherche super sympa (j'y reviendrais plus loin). Apr√®s 15 minutes de t√©l√©chargement (OK, j'ai une bonne ligne ADSL), l'installation se passe sans encombre. Je prends √©videmment la librairie MSDN avec moi. Pas besoin de [SQL Express](https://www.microsoft.com/france/msdn/vstudio/express/sqlexpress.mspx) pour mon besoin (pour l'instant). SQL Express est une base de donn√©es, bas√©e sur SQL Server et gratuite. SQL Express est id√©al pour les d√©veloppements, les tests, une utilisation en production avec quelques utilisateurs simultan√©s.

Evidemment, [j'active](https://www.microsoft.com/france/msdn/vstudio/express/register.mspx) mon Visual Basic Express 2005, qui permet d'avoir acc√®s √† de nombreux avantages :

* Corbis Image Pack ‚Äî Un assortiment de 250 images Corbis gratuites √† inclure dans vos sites Web et vos applications
* La suite IconBuffet Studio Edition Icon ‚Äî Une collection de plus de 100 ic√¥nes IconBuffet.com, professionnelles et gratuites
* Une vari√©t√© de composants ‚Äî Une s√©lection de composants √† utiliser dans vos applications
* Des livres √©lectroniques et des articles ‚Äî Des livres √©lectroniques Microsoft Press complets ainsi que des articles int√©ressants pour les d√©butants, les amateurs, et les personnes essayant les outils de d√©veloppement Microsoft pour la premi√®re fois.
  D'ailleurs en ce moment, il y a un [jeu Activ'Express avec 20 lots √† gagner chaque mois](https://www.microsoft.com/france/msdn/vstudio/express/jeu/default.mspx). Bref aucune excuse pour ne pas activer ses version de Visual Studio Express.

C√¥t√© d√©veloppement, je me dis que j'allais commencer par chercher dans l'aide. Toujours commencer par r√©fl√©chir avant de coder :-). D'ailleurs la bonne r√®gle, c'est autant de temps √† r√©fl√©chir qu'√† coder. Un nouveau menu est pr√©sent ¬´ Communaut√© ¬ª et ¬´ Recherche dans les communaut√©s ¬ª. A l'int√©rieur, on trouve des recherches sur des exemples. Je lance donc la recherche qui m'ouvre une nouvelle fen√™tre, je tape ¬´ envoi mail smtp ¬ª. J'obtiens de nombreux r√©sultats dont un tr√®s bien sur MSDN intitul√© ¬´ [Envoi de courrier, exemple](https://msdn2.microsoft.com/fr-fr/library/ms173026.aspx) ¬ª en ce qui concerne Microsoft et un autre tr√®s bien aussi sur le r√©seau [Codes-Sources](https://www.codes-sources.com) (superbement pilot√© par mon ami [Nix](https://blogs.developpeur.org/nix)) intitul√© ¬´ [VB.NET envoi de mail pas SMTP avec authentification](https://www.vbfrance.com/code.aspx?ID=28622) ¬ª.

R√©sultat : avec ces deux exemples, en moins de 10 minutes, j'avais fait mon programme. Tr√®s cool c√¥t√© productivit√©, moins cool c√¥t√© ¬´ me remettre √† faire un peu de code ¬ª. Du coup, c'est l√† que me vient l'id√©e d'aller plus loin et de r√©√©crire un logiciel qui permette de g√©rer mon onduleur ! Mon onduleur poss√®de deux ports de communication : s√©rie et USB. Je me lance pour s√©rie, je connais bien‚Ä¶

Cela me rappellera mon jeune temps de d√©veloppeur. J'√©tais √† l'√©poque √©tudiant √† [l'ENSAM](https://www.ensam.fr/sommaire/rubrique_sommaire.htm) (les Arts et M√©tiers). Je passais mon temps libre et mes vacances √† travailler pour la soci√©t√© [SAMx](https://www.samx.com/). Cet √©diteur de logiciel est sp√©cialis√© dans les logiciels d'analyse scientifique. Leurs logiciels communiquent avec des microsondes et spectrom√®tres √©lectroniques. La plupart de ces appareils √† l'√©poque ne communiquait qu'en port s√©rie et/ou parall√®le. Je me souviens d'un d√©veloppement o√π l'objectif √©tait de r√©cup√©rer des donn√©es (des images repr√©sentant des cartographies) depuis des [PDP](https://histoire.info.online.fr/pdp11.html) vers des PC (√† l'√©poque en 1996 sous Windows 95). C'√©tait l'√©poque des premiers ports parall√®le [EPP et ECP](https://en.wikipedia.org/wiki/IEEE_1284). La technologie n'√©tait tellement pas s√®che qu'il m'a fallut d√©velopper un dongle sp√©cifique pour r√©ussir √† fonctionner avec l'ensemble des chipsets disponibles sur le march√©. J'ai appris √† cette √©poque √† vraiment me servir d'un oscilloscope‚Ä¶ Au final, la solution fonctionnait parfaitement avec un port s√©rie sur lequel les informations de commande √©taient envoy√©es et un port parall√®le sur lequel les informations √©taient re√ßues. Pour les autres d√©veloppements, je n'avais que rarement acc√®s aux mat√©riels (une microsonde, cela prend une pi√®ce compl√®te, SAMx n'en poss√©dait pas, nous allions chez des clients faire les test) et je devait donc d'une part bien d√©velopper en respectant les protocoles de communication (document√©s dans des superbes docs comme celles des standards) et d'autre part bien √©muler les tests ! C'est √† cette √©poque que la [VT100](https://en.wikipedia.org/wiki/Vt100) est devenue une de mes meilleure amie.

De l√†, j'ai gard√© de tr√®s bons restes. Restes que j'ai appliqu√©s √† mon onduleur. Et vous comprendrez le titre de ce post au prochain post üòä
